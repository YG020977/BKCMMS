<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CMMS - Burger King France</title>
    <style>
        :root {
            --primary: #d32f2f;
            --primary-dark: #b71c1c;
            --secondary: #5c6bc0;
            --success: #4caf50;
            --warning: #ff9800;
            --danger: #f44336;
            --light-gray: #f5f5f5;
            --medium-gray: #e0e0e0;
            --dark-gray: #757575;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
            color: #333;
        }
        
        .header {
            background-color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            padding: 15px 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .app-title {
            color: var(--primary);
            text-align: center;
            margin: 0;
            padding: 10px 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .app-title img {
            height: 40px;
            margin-right: 15px;
        }
        
        .notification {
            padding: 10px 15px;
            margin: 10px 0;
            border-radius: 4px;
            display: none;
        }
        
        .notification.success {
            background-color: #e8f5e9;
            color: var(--success);
            display: block;
        }
        
        .notification.warning {
            background-color: #fff9c4;
            color: var(--warning);
            display: block;
        }
        
        .notification.error {
            background-color: #ffcdd2;
            color: var(--danger);
            display: block;
        }
        
        .tab-buttons {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .tab-button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background-color: var(--medium-gray);
            transition: all 0.3s;
        }
        
        .tab-button:hover {
            background-color: #d5d5d5;
        }
        
        .tab-button.active {
            background-color: var(--primary);
            color: white;
        }
        
        .tab {
            display: none;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.05);
        }
        
        .tab.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            font-family: inherit;
        }
        
        textarea.form-control {
            min-height: 100px;
            resize: vertical;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background-color: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: var(--primary-dark);
        }
        
        .btn-secondary {
            background-color: var(--secondary);
            color: white;
        }
        
        .btn-secondary:hover {
            opacity: 0.9;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background-color: var(--light-gray);
            font-weight: bold;
        }
        
        tr:hover {
            background-color: #f9f9f9;
        }
        
        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .badge-primary {
            background-color: var(--primary);
            color: white;
        }
        
        .badge-secondary {
            background-color: var(--secondary);
            color: white;
        }
        
        .badge-success {
            background-color: var(--success);
            color: white;
        }
        
        .badge-warning {
            background-color: var(--warning);
            color: white;
        }
        
        .badge-danger {
            background-color: var(--danger);
            color: white;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            overflow: auto;
        }
        
        .modal-content {
            background-color: white;
            margin: 50px auto;
            padding: 30px;
            border-radius: 8px;
            max-width: 800px;
            box-shadow: 0 0 20px rgba(0,0,0,0.2);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .modal-title {
            margin: 0;
            color: var(--primary);
        }
        
        .close {
            font-size: 24px;
            cursor: pointer;
            color: var(--dark-gray);
        }
        
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .dashboard-card {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.05);
            text-align: center;
        }
        
        .dashboard-card h3 {
            margin-top: 0;
            color: var(--dark-gray);
        }
        
        .card-value {
            font-size: 36px;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .card-value.primary {
            color: var(--primary);
        }
        
        .card-value.warning {
            color: var(--warning);
        }
        
        .card-value.success {
            color: var(--success);
        }
        
        .card-value.secondary {
            color: var(--secondary);
        }
        
        @media (max-width: 768px) {
            .tab-buttons {
                flex-direction: column;
            }
            
            .dashboard-cards {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                margin: 20px;
                width: auto;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1 class="app-title">
                <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/3/3a/Burger_King_Logo.svg/1200px-Burger_King_Logo.svg.png" alt="Burger King Logo">
                CMMS - Gestion de Maintenance
            </h1>
        </div>
    </div>

    <div class="container">
        <div id="notification" class="notification"></div>

        <div class="tab-buttons">
            <button class="tab-button active" onclick="showTab('dashboard')">Tableau de bord</button>
            <button class="tab-button" onclick="showTab('equipments')">Équipements</button>
            <button class="tab-button" onclick="showTab('tasks')">Tâches</button>
            <button class="tab-button" onclick="showTab('incidents')">Incidents</button>
            <button class="tab-button" onclick="showTab('reports')">Rapports</button>
        </div>

        <!-- Tableau de bord -->
        <div id="dashboard" class="tab active">
            <div class="dashboard-cards">
                <div class="dashboard-card">
                    <h3>Équipements</h3>
                    <div class="card-value primary" id="equipmentCount">0</div>
                    <p>Total des équipements enregistrés</p>
                </div>
                <div class="dashboard-card">
                    <h3>Tâches en cours</h3>
                    <div class="card-value warning" id="pendingTasksCount">0</div>
                    <p>Tâches à réaliser</p>
                </div>
                <div class="dashboard-card">
                    <h3>Incidents ouverts</h3>
                    <div class="card-value danger" id="openIncidentsCount">0</div>
                    <p>Incidents non résolus</p>
                </div>
                <div class="dashboard-card">
                    <h3>Tâches aujourd'hui</h3>
                    <div class="card-value secondary" id="todayTasksCount">0</div>
                    <p>Tâches prévues pour aujourd'hui</p>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div>
                    <h2>Tâches urgentes</h2>
                    <table id="urgentTasksTable">
                        <thead>
                            <tr>
                                <th>Équipement</th>
                                <th>Description</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div>
                    <h2>Incidents récents</h2>
                    <table id="recentIncidentsTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Titre</th>
                                <th>Statut</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Équipements -->
        <div id="equipments" class="tab">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>Gestion des équipements</h2>
                <button class="btn btn-primary" onclick="showEquipmentModal()">Ajouter un équipement</button>
            </div>
            
            <table id="equipmentTable">
                <thead>
                    <tr>
                        <th>Nom</th>
                        <th>Numéro de série</th>
                        <th>Localisation</th>
                        <th>Date installation</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="equipmentList"></tbody>
            </table>
        </div>

        <!-- Tâches -->
        <div id="tasks" class="tab">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>Gestion des tâches</h2>
                <button class="btn btn-primary" onclick="showTaskModal()">Planifier une tâche</button>
            </div>
            
            <table id="taskTable">
                <thead>
                    <tr>
                        <th>Équipement</th>
                        <th>Type</th>
                        <th>Description</th>
                        <th>Date prévue</th>
                        <th>Statut</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="taskList"></tbody>
            </table>
        </div>

        <!-- Incidents -->
        <div id="incidents" class="tab">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>Gestion des incidents</h2>
                <button class="btn btn-primary" onclick="showIncidentModal()">Déclarer un incident</button>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label for="incidentFilterStatus">Filtrer par statut :</label>
                <select id="incidentFilterStatus" class="form-control" onchange="loadIncidents()">
                    <option value="all">Tous les statuts</option>
                    <option value="open">Ouvert</option>
                    <option value="in_progress">En cours</option>
                    <option value="resolved">Résolu</option>
                    <option value="closed">Clôturé</option>
                </select>
            </div>
            
            <table id="incidentTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Titre</th>
                        <th>Équipement</th>
                        <th>Priorité</th>
                        <th>Statut</th>
                        <th>Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="incidentList"></tbody>
            </table>
        </div>

        <!-- Rapports -->
        <div id="reports" class="tab">
            <h2>Rapports de maintenance</h2>
            
            <div class="form-group">
                <label for="reportType">Type de rapport :</label>
                <select id="reportType" class="form-control">
                    <option value="equipment_list">Liste des équipements</option>
                    <option value="maintenance_tasks">Tâches de maintenance</option>
                    <option value="incident_report">Rapport d'incidents</option>
                    <option value="preventive_maintenance">Maintenance préventive</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="reportPeriod">Période :</label>
                <select id="reportPeriod" class="form-control">
                    <option value="all">Toutes les données</option>
                    <option value="today">Aujourd'hui</option>
                    <option value="week">Cette semaine</option>
                    <option value="month">Ce mois</option>
                    <option value="quarter">Ce trimestre</option>
                    <option value="year">Cette année</option>
                    <option value="custom">Personnalisée</option>
                </select>
            </div>
            
            <div id="customDateRange" style="display: none;">
                <div class="form-group">
                    <label for="startDate">Date de début :</label>
                    <input type="date" id="startDate" class="form-control">
                </div>
                <div class="form-group">
                    <label for="endDate">Date de fin :</label>
                    <input type="date" id="endDate" class="form-control">
                </div>
            </div>
            
            <button class="btn btn-primary" onclick="generateReport()">Générer le rapport</button>
            
            <div id="reportOutput" style="margin-top: 30px;"></div>
        </div>
    </div>

    <!-- Modals -->
    <div id="equipmentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Nouvel équipement</h3>
                <span class="close" onclick="closeModal('equipmentModal')">&times;</span>
            </div>
            <div class="form-group">
                <label for="modalEquipmentName">Nom de l'équipement</label>
                <input type="text" id="modalEquipmentName" class="form-control" placeholder="Ex: Friteuse 1">
            </div>
            <div class="form-group">
                <label for="modalEquipmentSerial">Numéro de série</label>
                <input type="text" id="modalEquipmentSerial" class="form-control" placeholder="Ex: FR123456">
            </div>
            <div class="form-group">
                <label for="modalEquipmentLocation">Localisation (Restaurant)</label>
                <input type="text" id="modalEquipmentLocation" class="form-control" placeholder="Ex: Paris - Champs-Élysées">
            </div>
            <div class="form-group">
                <label for="modalEquipmentType">Type d'équipement</label>
                <select id="modalEquipmentType" class="form-control">
                    <option value="friteuse">Friteuse</option>
                    <option value="grill">Grill</option>
                    <option value="refrigerateur">Réfrigérateur</option>
                    <option value="congelateur">Congélateur</option>
                    <option value="machine_cafe">Machine à café</option>
                    <option value="autre">Autre</option>
                </select>
            </div>
            <div class="form-group">
                <label for="modalEquipmentInstallDate">Date d'installation</label>
                <input type="date" id="modalEquipmentInstallDate" class="form-control">
            </div>
            <div class="form-group">
                <label for="modalEquipmentNotes">Notes</label>
                <textarea id="modalEquipmentNotes" class="form-control" placeholder="Informations supplémentaires"></textarea>
            </div>
            <button class="btn btn-primary" onclick="saveEquipment()">Enregistrer</button>
        </div>
    </div>

    <div id="taskModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Nouvelle tâche</h3>
                <span class="close" onclick="closeModal('taskModal')">&times;</span>
            </div>
            <div class="form-group">
                <label for="modalTaskEquipment">Équipement</label>
                <select id="modalTaskEquipment" class="form-control">
                    <option value="">Sélectionner un équipement</option>
                </select>
            </div>
            <div class="form-group">
                <label for="modalTaskType">Type de maintenance</label>
                <select id="modalTaskType" class="form-control">
                    <option value="preventive">Préventive</option>
                    <option value="corrective">Corrective</option>
                    <option value="safety">Sécurité</option>
                    <option value="cleaning">Nettoyage</option>
                </select>
            </div>
            <div class="form-group">
                <label for="modalTaskFrequency">Périodicité</label>
                <select id="modalTaskFrequency" class="form-control">
                    <option value="once">Une seule fois</option>
                    <option value="daily">Quotidienne</option>
                    <option value="weekly">Hebdomadaire</option>
                    <option value="monthly">Mensuelle</option>
                    <option value="quarterly">Trimestrielle</option>
                    <option value="yearly">Annuelle</option>
                </select>
            </div>
            <div class="form-group">
                <label for="modalTaskDescription">Description</label>
                <textarea id="modalTaskDescription" class="form-control" placeholder="Décrire la tâche à effectuer"></textarea>
            </div>
            <div class="form-group">
                <label for="modalTaskDueDate">Date prévue</label>
                <input type="date" id="modalTaskDueDate" class="form-control">
            </div>
            <div class="form-group" id="recurrenceEndDateGroup" style="display: none;">
                <label for="modalTaskEndDate">Date de fin de récurrence</label>
                <input type="date" id="modalTaskEndDate" class="form-control">
            </div>
            <div class="form-group">
                <label for="modalTaskAssignedTo">Assigné à</label>
                <input type="text" id="modalTaskAssignedTo" class="form-control" placeholder="Nom du technicien">
            </div>
            <div class="form-group">
                <label for="modalTaskPriority">Priorité</label>
                <select id="modalTaskPriority" class="form-control">
                    <option value="low">Basse</option>
                    <option value="medium">Moyenne</option>
                    <option value="high">Haute</option>
                </select>
            </div>
            <button class="btn btn-primary" onclick="saveTask()">Planifier</button>
        </div>
    </div>

    <!-- Nouvelle modal pour l'édition simplifiée des tâches -->
    <div id="taskEditModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title">Modifier la tâche</h3>
                <span class="close" onclick="closeModal('taskEditModal')">&times;</span>
            </div>
            <div class="form-group">
                <label for="editTaskStatus">Statut</label>
                <select id="editTaskStatus" class="form-control">
                    <option value="pending">En attente</option>
                    <option value="completed">Réalisée</option>
                </select>
            </div>
            <div class="form-group">
                <label for="editTaskRemarks">Remarques</label>
                <textarea id="editTaskRemarks" class="form-control" placeholder="Ajoutez des remarques si nécessaire"></textarea>
            </div>
            <button class="btn btn-primary" onclick="updateTask()">Enregistrer</button>
        </div>
    </div>

    <div id="incidentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Nouvel incident</h3>
                <span class="close" onclick="closeModal('incidentModal')">&times;</span>
            </div>
            <div class="form-group">
                <label for="modalIncidentEquipment">Équipement concerné</label>
                <select id="modalIncidentEquipment" class="form-control">
                    <option value="">Sélectionner un équipement</option>
                </select>
            </div>
            <div class="form-group">
                <label for="modalIncidentTitle">Titre de l'incident</label>
                <input type="text" id="modalIncidentTitle" class="form-control" placeholder="Ex: Friteuse en panne">
            </div>
            <div class="form-group">
                <label for="modalIncidentPriority">Priorité</label>
                <select id="modalIncidentPriority" class="form-control">
                    <option value="low">Basse</option>
                    <option value="medium">Moyenne</option>
                    <option value="high">Haute</option>
                    <option value="critical">Critique</option>
                </select>
            </div>
            <div class="form-group">
                <label for="modalIncidentDescription">Description</label>
                <textarea id="modalIncidentDescription" class="form-control" placeholder="Décrire l'incident en détail"></textarea>
            </div>
            <div class="form-group">
                <label for="modalIncidentReporter">Déclaré par</label>
                <input type="text" id="modalIncidentReporter" class="form-control" placeholder="Votre nom">
            </div>
            <button class="btn btn-primary" onclick="saveIncident()">Enregistrer</button>
        </div>
    </div>

    <div id="incidentDetailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="incidentDetailTitle">Détails de l'incident</h3>
                <span class="close" onclick="closeModal('incidentDetailModal')">&times;</span>
            </div>
            <div style="margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <div><strong>Équipement :</strong> <span id="incidentDetailEquipment"></span></div>
                    <div><strong>Statut :</strong> <span id="incidentDetailStatus" class="badge"></span></div>
                </div>
                <div style="margin-bottom: 10px;">
                    <strong>Priorité :</strong> <span id="incidentDetailPriority" class="badge"></span>
                </div>
                <div style="margin-bottom: 10px;">
                    <strong>Date :</strong> <span id="incidentDetailDate"></span>
                </div>
                <div style="margin-bottom: 10px;">
                    <strong>Déclaré par :</strong> <span id="incidentDetailReporter"></span>
                </div>
                <div style="margin-bottom: 10px;">
                    <strong>Description :</strong>
                    <p id="incidentDetailDescription"></p>
                </div>
            </div>
            
            <h4>Journal des interventions</h4>
            <div id="incidentInterventionLog" style="margin-bottom: 20px;"></div>
            
            <div id="incidentActionForm">
                <h4>Ajouter une intervention</h4>
                <div class="form-group">
                    <label for="interventionTechnician">Technicien</label>
                    <input type="text" id="interventionTechnician" class="form-control" placeholder="Nom du technicien">
                </div>
                <div class="form-group">
                    <label for="interventionAction">Action réalisée</label>
                    <textarea id="interventionAction" class="form-control" placeholder="Décrire l'intervention"></textarea>
                </div>
                <div class="form-group">
                    <label for="interventionStatus">Nouveau statut</label>
                    <select id="interventionStatus" class="form-control">
                        <option value="in_progress">En cours</option>
                        <option value="resolved">Résolu</option>
                        <option value="closed">Clôturé</option>
                    </select>
                </div>
                <button class="btn btn-primary" onclick="addIntervention()">Enregistrer l'intervention</button>
            </div>
        </div>
    </div>

    <script>
        // Base de données IndexedDB
        let db;
        const DB_NAME = "BurgerKingCMMS";
        const DB_VERSION = 1;
        
        // Variables globales
        let currentIncidentId = null;
        let currentTaskId = null;
        
        // Ouvrir ou créer la base de données
        const request = indexedDB.open(DB_NAME, DB_VERSION);
        
        request.onupgradeneeded = function(event) {
            db = event.target.result;
            
            // Créer le store pour les équipements
            const equipmentStore = db.createObjectStore("equipments", { keyPath: "id", autoIncrement: true });
            equipmentStore.createIndex("location", "location", { unique: false });
            equipmentStore.createIndex("type", "type", { unique: false });
            
            // Créer le store pour les tâches
            const taskStore = db.createObjectStore("tasks", { keyPath: "id", autoIncrement: true });
            taskStore.createIndex("equipmentId", "equipmentId", { unique: false });
            taskStore.createIndex("status", "status", { unique: false });
            taskStore.createIndex("dueDate", "dueDate", { unique: false });
            taskStore.createIndex("type", "type", { unique: false });
            
            // Créer le store pour les incidents
            const incidentStore = db.createObjectStore("incidents", { keyPath: "id", autoIncrement: true });
            incidentStore.createIndex("equipmentId", "equipmentId", { unique: false });
            incidentStore.createIndex("status", "status", { unique: false });
            incidentStore.createIndex("priority", "priority", { unique: false });
            incidentStore.createIndex("date", "date", { unique: false });
            
            // Créer le store pour les interventions
            const interventionStore = db.createObjectStore("interventions", { keyPath: "id", autoIncrement: true });
            interventionStore.createIndex("incidentId", "incidentId", { unique: false });
            interventionStore.createIndex("date", "date", { unique: false });
        };
        
        request.onsuccess = function(event) {
            db = event.target.result;
            loadDashboard();
            loadEquipments();
            loadTasks();
            loadIncidents();
        };
        
        request.onerror = function(event) {
            console.error("Erreur d'ouverture de la base de données:", event.target.error);
            showNotification("Erreur de connexion à la base de données", "error");
        };
        
        // Fonctions d'affichage
        function showTab(tabId) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            
            document.getElementById(tabId).classList.add('active');
            document.querySelector(`.tab-button[onclick="showTab('${tabId}')"]`).classList.add('active');
            
            // Recharger les données si nécessaire
            if (tabId === 'dashboard') {
                loadDashboard();
            } else if (tabId === 'equipments') {
                loadEquipments();
            } else if (tabId === 'tasks') {
                loadTasks();
            } else if (tabId === 'incidents') {
                loadIncidents();
            }
        }
        
        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 5000);
        }
        
        // Fonctions pour les équipements
        function showEquipmentModal(equipmentId) {
            if (equipmentId) {
                // Mode édition
                const transaction = db.transaction(["equipments"], "readonly");
                const store = transaction.objectStore("equipments");
                const request = store.get(equipmentId);
                
                request.onsuccess = function(event) {
                    const equipment = event.target.result;
                    document.getElementById('modalEquipmentName').value = equipment.name;
                    document.getElementById('modalEquipmentSerial').value = equipment.serial;
                    document.getElementById('modalEquipmentLocation').value = equipment.location;
                    document.getElementById('modalEquipmentType').value = equipment.type;
                    document.getElementById('modalEquipmentInstallDate').value = equipment.installDate;
                    document.getElementById('modalEquipmentNotes').value = equipment.notes || '';
                };
            } else {
                // Mode création
                document.getElementById('modalEquipmentName').value = '';
                document.getElementById('modalEquipmentSerial').value = '';
                document.getElementById('modalEquipmentLocation').value = '';
                document.getElementById('modalEquipmentType').value = 'friteuse';
                document.getElementById('modalEquipmentInstallDate').value = '';
                document.getElementById('modalEquipmentNotes').value = '';
            }
            
            showModal('equipmentModal');
        }
        
        function saveEquipment() {
            const name = document.getElementById('modalEquipmentName').value;
            const serial = document.getElementById('modalEquipmentSerial').value;
            const location = document.getElementById('modalEquipmentLocation').value;
            const type = document.getElementById('modalEquipmentType').value;
            const installDate = document.getElementById('modalEquipmentInstallDate').value;
            const notes = document.getElementById('modalEquipmentNotes').value;
            
            if (!name || !serial || !location || !installDate) {
                showNotification("Veuillez remplir tous les champs obligatoires", "error");
                return;
            }
            
            const equipment = {
                name,
                serial,
                location,
                type,
                installDate,
                notes,
                createdAt: new Date().toISOString()
            };
            
            const transaction = db.transaction(["equipments"], "readwrite");
            const store = transaction.objectStore("equipments");
            
            store.add(equipment);
            
            transaction.oncomplete = function() {
                showNotification("Équipement enregistré avec succès", "success");
                closeModal('equipmentModal');
                loadEquipments();
                loadDashboard();
            };
            
            transaction.onerror = function(event) {
                console.error("Erreur d'enregistrement:", event.target.error);
                showNotification("Erreur lors de l'enregistrement", "error");
            };
        }
        
        function loadEquipments() {
            const transaction = db.transaction(["equipments"], "readonly");
            const store = transaction.objectStore("equipments");
            const request = store.getAll();
            
            request.onsuccess = function(event) {
                const equipments = event.target.result;
                const equipmentList = document.getElementById('equipmentList');
                const taskEquipmentSelect = document.getElementById('modalTaskEquipment');
                const incidentEquipmentSelect = document.getElementById('modalIncidentEquipment');
                
                equipmentList.innerHTML = '';
                taskEquipmentSelect.innerHTML = '<option value="">Sélectionner un équipement</option>';
                incidentEquipmentSelect.innerHTML = '<option value="">Sélectionner un équipement</option>';
                
                equipments.forEach(equipment => {
                    // Ajouter à la liste des équipements
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${equipment.name}</td>
                        <td>${equipment.serial}</td>
                        <td>${equipment.location}</td>
                        <td>${equipment.installDate}</td>
                        <td>
                            <button class="btn btn-secondary" onclick="showEquipmentModal(${equipment.id})">Modifier</button>
                        </td>
                    `;
                    equipmentList.appendChild(row);
                    
                    // Ajouter aux menus déroulants
                    const option = document.createElement('option');
                    option.value = equipment.id;
                    option.textContent = `${equipment.name} (${equipment.location})`;
                    
                    taskEquipmentSelect.appendChild(option.cloneNode(true));
                    incidentEquipmentSelect.appendChild(option.cloneNode(true));
                });
            };
        }
        
        // Fonctions pour les tâches
        function showTaskModal(taskId) {
            if (taskId) {
                // Mode édition
                const transaction = db.transaction(["tasks"], "readonly");
                const store = transaction.objectStore("tasks");
                const request = store.get(taskId);
                
                request.onsuccess = function(event) {
                    const task = event.target.result;
                    document.getElementById('modalTaskEquipment').value = task.equipmentId;
                    document.getElementById('modalTaskType').value = task.type;
                    document.getElementById('modalTaskFrequency').value = task.frequency || 'once';
                    document.getElementById('modalTaskDescription').value = task.description;
                    document.getElementById('modalTaskDueDate').value = task.dueDate;
                    document.getElementById('modalTaskAssignedTo').value = task.assignedTo;
                    document.getElementById('modalTaskPriority').value = task.priority || 'medium';
                    
                    // Afficher/masquer le champ de fin selon la périodicité
                    document.getElementById('recurrenceEndDateGroup').style.display = 
                        task.frequency === null || task.frequency === 'once' ? 'none' : 'block';
                };
            } else {
                // Mode création
                document.getElementById('modalTaskEquipment').value = '';
                document.getElementById('modalTaskType').value = 'preventive';
                document.getElementById('modalTaskFrequency').value = 'once';
                document.getElementById('modalTaskDescription').value = '';
                document.getElementById('modalTaskDueDate').value = '';
                document.getElementById('modalTaskEndDate').value = '';
                document.getElementById('modalTaskAssignedTo').value = '';
                document.getElementById('modalTaskPriority').value = 'medium';
                
                // Gérer l'affichage du champ de fin selon la périodicité
                document.getElementById('modalTaskFrequency').addEventListener('change', function() {
                    document.getElementById('recurrenceEndDateGroup').style.display = 
                        this.value === 'once' ? 'none' : 'block';
                });
            }
            
            showModal('taskModal');
        }
        
        function showEditTaskModal(taskId) {
            currentTaskId = taskId;
            
            const transaction = db.transaction(["tasks"], "readonly");
            const store = transaction.objectStore("tasks");
            const request = store.get(taskId);
            
            request.onsuccess = function(event) {
                const task = event.target.result;
                document.getElementById('editTaskStatus').value = task.status;
                document.getElementById('editTaskRemarks').value = task.remarks || '';
                
                showModal('taskEditModal');
            };
        }
        
        function updateTask() {
            const status = document.getElementById('editTaskStatus').value;
            const remarks = document.getElementById('editTaskRemarks').value;
            
            const transaction = db.transaction(["tasks"], "readwrite");
            const store = transaction.objectStore("tasks");
            const request = store.get(currentTaskId);
            
            request.onsuccess = function(event) {
                const task = event.target.result;
                task.status = status;
                task.remarks = remarks;
                
                store.put(task);
            };
            
            transaction.oncomplete = function() {
                showNotification("Tâche mise à jour avec succès", "success");
                closeModal('taskEditModal');
                loadTasks();
                loadDashboard();
            };
            
            transaction.onerror = function(event) {
                console.error("Erreur de mise à jour:", event.target.error);
                showNotification("Erreur lors de la mise à jour", "error");
            };
        }
        
        function generateRecurringTasks(startDate, frequency, endDate) {
            const dates = [new Date(startDate)];
            if (frequency === 'once' || !endDate) return dates;
            
            let currentDate = new Date(startDate);
            const end = new Date(endDate);
            
            while (true) {
                const newDate = new Date(currentDate);
                
                switch(frequency) {
                    case 'daily':
                        newDate.setDate(newDate.getDate() + 1);
                        break;
                    case 'weekly':
                        newDate.setDate(newDate.getDate() + 7);
                        break;
                    case 'monthly':
                        newDate.setMonth(newDate.getMonth() + 1);
                        break;
                    case 'quarterly':
                        newDate.setMonth(newDate.getMonth() + 3);
                        break;
                    case 'yearly':
                        newDate.setFullYear(newDate.getFullYear() + 1);
                        break;
                }
                
                if (newDate > end) break;
                
                dates.push(new Date(newDate));
                currentDate = newDate;
                
                // Sécurité pour éviter les boucles infinies
                if (dates.length > 365) break;
            }
            
            return dates;
        }
        
        function saveTask() {
            const equipmentId = document.getElementById('modalTaskEquipment').value;
            const type = document.getElementById('modalTaskType').value;
            const frequency = document.getElementById('modalTaskFrequency').value;
            const description = document.getElementById('modalTaskDescription').value;
            const dueDate = document.getElementById('modalTaskDueDate').value;
            const endDate = document.getElementById('modalTaskEndDate').value;
            const assignedTo = document.getElementById('modalTaskAssignedTo').value;
            const priority = document.getElementById('modalTaskPriority').value;
            
            if (!equipmentId || !description || !dueDate || !assignedTo) {
                showNotification("Veuillez remplir tous les champs obligatoires", "error");
                return;
            }
            
            if (frequency !== 'once' && !endDate) {
                showNotification("Veuillez spécifier une date de fin pour les tâches récurrentes", "error");
                return;
            }
            
            const transaction = db.transaction(["tasks", "equipments"], "readwrite");
            const taskStore = transaction.objectStore("tasks");
            const equipmentStore = transaction.objectStore("equipments");
            
            // Récupérer le nom de l'équipement
            equipmentStore.get(parseInt(equipmentId)).onsuccess = function(event) {
                const equipment = event.target.result;
                
                // Générer toutes les dates
                const taskDates = generateRecurringTasks(dueDate, frequency, endDate);
                
                // Créer une tâche pour chaque date
                taskDates.forEach(taskDate => {
                    const task = {
                        equipmentId: parseInt(equipmentId),
                        equipmentName: equipment.name,
                        equipmentLocation: equipment.location,
                        type,
                        frequency: frequency === 'once' ? null : frequency,
                        description,
                        dueDate: taskDate.toISOString().split('T')[0],
                        assignedTo,
                        priority,
                        status: 'pending',
                        createdAt: new Date().toISOString()
                    };
                    
                    taskStore.add(task);
                });
                
                transaction.oncomplete = function() {
                    const taskCount = taskDates.length;
                    showNotification(`${taskCount} tâche(s) enregistrée(s) avec succès`, "success");
                    closeModal('taskModal');
                    loadTasks();
                    loadDashboard();
                };
                
                transaction.onerror = function(event) {
                    console.error("Erreur d'enregistrement:", event.target.error);
                    showNotification("Erreur lors de l'enregistrement", "error");
                };
            };
        }
        
        function loadTasks() {
            const transaction = db.transaction(["tasks"], "readonly");
            const store = transaction.objectStore("tasks");
            const request = store.getAll();
            
            request.onsuccess = function(event) {
                const tasks = event.target.result;
                const taskList = document.getElementById('taskList');
                
                taskList.innerHTML = '';
                
                tasks.sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
                
                tasks.forEach(task => {
                    let statusBadge;
                    switch(task.status) {
                        case 'pending':
                            statusBadge = '<span class="badge badge-warning">En attente</span>';
                            break;
                        case 'completed':
                            statusBadge = '<span class="badge badge-success">Réalisée</span>';
                            break;
                        default:
                            statusBadge = `<span class="badge">${task.status}</span>`;
                    }
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${task.equipmentName}</td>
                        <td>${getTaskTypeLabel(task.type)}</td>
                        <td>${task.description}</td>
                        <td>${task.dueDate}</td>
                        <td>${statusBadge}</td>
                        <td>
                            <button class="btn btn-secondary" onclick="showEditTaskModal(${task.id})">Modifier</button>
                        </td>
                    `;
                    taskList.appendChild(row);
                });
            };
        }
        
        function getTaskTypeLabel(type) {
            switch(type) {
                case 'preventive': return 'Préventive';
                case 'corrective': return 'Corrective';
                case 'safety': return 'Sécurité';
                case 'cleaning': return 'Nettoyage';
                default: return type;
            }
        }
        
        // Fonctions pour les incidents
        function showIncidentModal(incidentId) {
            if (incidentId) {
                // Mode édition
                const transaction = db.transaction(["incidents"], "readonly");
                const store = transaction.objectStore("incidents");
                const request = store.get(incidentId);
                
                request.onsuccess = function(event) {
                    const incident = event.target.result;
                    document.getElementById('modalIncidentEquipment').value = incident.equipmentId;
                    document.getElementById('modalIncidentTitle').value = incident.title;
                    document.getElementById('modalIncidentPriority').value = incident.priority;
                    document.getElementById('modalIncidentDescription').value = incident.description;
                    document.getElementById('modalIncidentReporter').value = incident.reporter;
                };
            } else {
                // Mode création
                document.getElementById('modalIncidentEquipment').value = '';
                document.getElementById('modalIncidentTitle').value = '';
                document.getElementById('modalIncidentPriority').value = 'medium';
                document.getElementById('modalIncidentDescription').value = '';
                document.getElementById('modalIncidentReporter').value = '';
            }
            
            showModal('incidentModal');
        }
        
        function saveIncident() {
            const equipmentId = document.getElementById('modalIncidentEquipment').value;
            const title = document.getElementById('modalIncidentTitle').value;
            const priority = document.getElementById('modalIncidentPriority').value;
            const description = document.getElementById('modalIncidentDescription').value;
            const reporter = document.getElementById('modalIncidentReporter').value;
            
            if (!equipmentId || !title || !description || !reporter) {
                showNotification("Veuillez remplir tous les champs obligatoires", "error");
                return;
            }
            
            const incident = {
                equipmentId: parseInt(equipmentId),
                title,
                priority,
                description,
                reporter,
                status: 'open',
                date: new Date().toISOString(),
                createdAt: new Date().toISOString()
            };
            
            const transaction = db.transaction(["incidents", "equipments"], "readwrite");
            const incidentStore = transaction.objectStore("incidents");
            const equipmentStore = transaction.objectStore("equipments");
            
            // Récupérer le nom de l'équipement
            equipmentStore.get(parseInt(equipmentId)).onsuccess = function(event) {
                const equipment = event.target.result;
                incident.equipmentName = equipment.name;
                incident.equipmentLocation = equipment.location;
                
                incidentStore.add(incident);
            };
            
            transaction.oncomplete = function() {
                showNotification("Incident enregistré avec succès", "success");
                closeModal('incidentModal');
                loadIncidents();
                loadDashboard();
            };
            
            transaction.onerror = function(event) {
                console.error("Erreur d'enregistrement:", event.target.error);
                showNotification("Erreur lors de l'enregistrement", "error");
            };
        }
        
        function loadIncidents() {
            const statusFilter = document.getElementById('incidentFilterStatus').value;
            const transaction = db.transaction(["incidents"], "readonly");
            const store = transaction.objectStore("incidents");
            const request = store.getAll();
            
            request.onsuccess = function(event) {
                const incidents = event.target.result;
                const incidentList = document.getElementById('incidentList');
                
                incidentList.innerHTML = '';
                
                // Filtrer par statut si nécessaire
                const filteredIncidents = statusFilter === 'all' 
                    ? incidents 
                    : incidents.filter(incident => incident.status === statusFilter);
                
                // Trier par date (les plus récents en premier)
                filteredIncidents.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                filteredIncidents.forEach(incident => {
                    let priorityBadge;
                    switch(incident.priority) {
                        case 'low':
                            priorityBadge = '<span class="badge badge-success">Basse</span>';
                            break;
                        case 'medium':
                            priorityBadge = '<span class="badge badge-warning">Moyenne</span>';
                            break;
                        case 'high':
                            priorityBadge = '<span class="badge badge-danger">Haute</span>';
                            break;
                        case 'critical':
                            priorityBadge = '<span class="badge badge-danger">Critique</span>';
                            break;
                        default:
                            priorityBadge = `<span class="badge">${incident.priority}</span>`;
                    }
                    
                    let statusBadge;
                    switch(incident.status) {
                        case 'open':
                            statusBadge = '<span class="badge badge-warning">Ouvert</span>';
                            break;
                        case 'in_progress':
                            statusBadge = '<span class="badge badge-primary">En cours</span>';
                            break;
                        case 'resolved':
                            statusBadge = '<span class="badge badge-success">Résolu</span>';
                            break;
                        case 'closed':
                            statusBadge = '<span class="badge">Clôturé</span>';
                            break;
                        default:
                            statusBadge = `<span class="badge">${incident.status}</span>`;
                    }
                    
                    const date = new Date(incident.date);
                    const formattedDate = `${date.getDate()}/${date.getMonth()+1}/${date.getFullYear()}`;
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${incident.id}</td>
                        <td>${incident.title}</td>
                        <td>${incident.equipmentName} (${incident.equipmentLocation})</td>
                        <td>${priorityBadge}</td>
                        <td>${statusBadge}</td>
                        <td>${formattedDate}</td>
                        <td>
                            <button class="btn btn-secondary" onclick="viewIncidentDetails(${incident.id})">Détails</button>
                        </td>
                    `;
                    incidentList.appendChild(row);
                });
            };
        }
        
        function viewIncidentDetails(incidentId) {
            currentIncidentId = incidentId;
            
            const transaction = db.transaction(["incidents", "interventions", "equipments"], "readonly");
            const incidentStore = transaction.objectStore("incidents");
            const interventionStore = transaction.objectStore("interventions");
            const equipmentStore = transaction.objectStore("equipments");
            
            incidentStore.get(incidentId).onsuccess = function(event) {
                const incident = event.target.result;
                
                document.getElementById('incidentDetailTitle').textContent = `Incident #${incident.id}: ${incident.title}`;
                document.getElementById('incidentDetailEquipment').textContent = `${incident.equipmentName} (${incident.equipmentLocation})`;
                document.getElementById('incidentDetailDescription').textContent = incident.description;
                document.getElementById('incidentDetailReporter').textContent = incident.reporter;
                
                // Formater la date
                const date = new Date(incident.date);
                const formattedDate = `${date.getDate()}/${date.getMonth()+1}/${date.getFullYear()} à ${date.getHours()}:${date.getMinutes().toString().padStart(2, '0')}`;
                document.getElementById('incidentDetailDate').textContent = formattedDate;
                
                // Mettre à jour le statut et la priorité
                const statusBadge = document.getElementById('incidentDetailStatus');
                statusBadge.className = 'badge';
                
                switch(incident.status) {
                    case 'open':
                        statusBadge.classList.add('badge-warning');
                        statusBadge.textContent = 'Ouvert';
                        break;
                    case 'in_progress':
                        statusBadge.classList.add('badge-primary');
                        statusBadge.textContent = 'En cours';
                        break;
                    case 'resolved':
                        statusBadge.classList.add('badge-success');
                        statusBadge.textContent = 'Résolu';
                        break;
                    case 'closed':
                        statusBadge.textContent = 'Clôturé';
                        break;
                    default:
                        statusBadge.textContent = incident.status;
                }
                
                const priorityBadge = document.getElementById('incidentDetailPriority');
                priorityBadge.className = 'badge';
                
                switch(incident.priority) {
                    case 'low':
                        priorityBadge.classList.add('badge-success');
                        priorityBadge.textContent = 'Basse';
                        break;
                    case 'medium':
                        priorityBadge.classList.add('badge-warning');
                        priorityBadge.textContent = 'Moyenne';
                        break;
                    case 'high':
                    case 'critical':
                        priorityBadge.classList.add('badge-danger');
                        priorityBadge.textContent = incident.priority === 'high' ? 'Haute' : 'Critique';
                        break;
                    default:
                        priorityBadge.textContent = incident.priority;
                }
                
                // Charger les interventions
                const interventionIndex = interventionStore.index("incidentId");
                const interventionRequest = interventionIndex.getAll(incidentId);
                
                interventionRequest.onsuccess = function(event) {
                    const interventions = event.target.result;
                    const interventionLog = document.getElementById('incidentInterventionLog');
                    
                    interventionLog.innerHTML = '';
                    
                    interventions.sort((a, b) => new Date(a.date) - new Date(b.date));
                    
                    interventions.forEach(intervention => {
                        const entry = document.createElement('div');
                        entry.className = 'intervention-entry';
                        
                        const date = new Date(intervention.date);
                        const formattedDate = `${date.getDate()}/${date.getMonth()+1}/${date.getFullYear()} à ${date.getHours()}:${date.getMinutes().toString().padStart(2, '0')}`;
                        
                        let statusText;
                        switch(intervention.newStatus) {
                            case 'in_progress':
                                statusText = 'En cours';
                                break;
                            case 'resolved':
                                statusText = 'Résolu';
                                break;
                            case 'closed':
                                statusText = 'Clôturé';
                                break;
                            default:
                                statusText = intervention.newStatus;
                        }
                        
                        entry.innerHTML = `
                            <div><strong>${formattedDate}</strong> - ${intervention.technician}</div>
                            <div><strong>Action :</strong> ${intervention.action}</div>
                            <div><strong>Nouveau statut :</strong> ${statusText}</div>
                        `;
                        interventionLog.appendChild(entry);
                    });
                    
                    // Afficher le modal
                    showModal('incidentDetailModal');
                };
            };
        }
        
        function addIntervention() {
            const technician = document.getElementById('interventionTechnician').value;
            const action = document.getElementById('interventionAction').value;
            const newStatus = document.getElementById('interventionStatus').value;
            
            if (!technician || !action) {
                showNotification("Veuillez remplir tous les champs obligatoires", "error");
                return;
            }
            
            const intervention = {
                incidentId: currentIncidentId,
                technician,
                action,
                newStatus,
                date: new Date().toISOString()
            };
            
            const transaction = db.transaction(["interventions", "incidents"], "readwrite");
            const interventionStore = transaction.objectStore("interventions");
            const incidentStore = transaction.objectStore("incidents");
            
            // Ajouter l'intervention
            interventionStore.add(intervention);
            
            // Mettre à jour le statut de l'incident
            incidentStore.get(currentIncidentId).onsuccess = function(event) {
                const incident = event.target.result;
                incident.status = newStatus;
                incidentStore.put(incident);
            };
            
            transaction.oncomplete = function() {
                showNotification("Intervention enregistrée avec succès", "success");
                document.getElementById('interventionTechnician').value = '';
                document.getElementById('interventionAction').value = '';
                
                // Recharger les détails de l'incident
                viewIncidentDetails(currentIncidentId);
                
                // Recharger la liste des incidents
                loadIncidents();
                loadDashboard();
            };
            
            transaction.onerror = function(event) {
                console.error("Erreur d'enregistrement:", event.target.error);
                showNotification("Erreur lors de l'enregistrement", "error");
            };
        }
        
        // Fonctions pour le tableau de bord
        function loadDashboard() {
            const transaction = db.transaction(["equipments", "tasks", "incidents"], "readonly");
            const equipmentStore = transaction.objectStore("equipments");
            const taskStore = transaction.objectStore("tasks");
            const incidentStore = transaction.objectStore("incidents");
            
            // Compter les équipements
            equipmentStore.count().onsuccess = function(event) {
                document.getElementById('equipmentCount').textContent = event.target.result;
            };
            
            // Compter les tâches en attente
            const pendingTasksIndex = taskStore.index("status");
            pendingTasksIndex.count("pending").onsuccess = function(event) {
                document.getElementById('pendingTasksCount').textContent = event.target.result;
            };
            
            // Compter les incidents ouverts
            const openIncidentsIndex = incidentStore.index("status");
            openIncidentsIndex.count("open").onsuccess = function(event) {
                document.getElementById('openIncidentsCount').textContent = event.target.result;
            };
            
            // Compter les tâches pour aujourd'hui
            const today = new Date().toISOString().split('T')[0];
            const taskDueDateIndex = taskStore.index("dueDate");
            const todayTasksRequest = taskDueDateIndex.getAll(today);
            
            todayTasksRequest.onsuccess = function(event) {
                document.getElementById('todayTasksCount').textContent = event.target.result.length;
                
                // Afficher les tâches urgentes
                const urgentTasksTable = document.getElementById('urgentTasksTable').querySelector('tbody');
                urgentTasksTable.innerHTML = '';
                
                event.target.result.forEach(task => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${task.equipmentName} (${task.equipmentLocation})</td>
                        <td>${task.description}</td>
                        <td>${task.dueDate}</td>
                    `;
                    urgentTasksTable.appendChild(row);
                });
            };
            
            // Afficher les incidents récents
            incidentStore.getAll().onsuccess = function(event) {
                const incidents = event.target.result
                    .sort((a, b) => new Date(b.date) - new Date(a.date))
                    .slice(0, 5);
                
                const recentIncidentsTable = document.getElementById('recentIncidentsTable').querySelector('tbody');
                recentIncidentsTable.innerHTML = '';
                
                incidents.forEach(incident => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${incident.id}</td>
                        <td>${incident.title}</td>
                        <td>${incident.status === 'open' ? 'Ouvert' : 
                             incident.status === 'in_progress' ? 'En cours' : 
                             incident.status === 'resolved' ? 'Résolu' : 'Clôturé'}</td>
                    `;
                    recentIncidentsTable.appendChild(row);
                });
            };
        }
        
        // Fonctions pour les rapports
        function generateReport() {
            const reportType = document.getElementById('reportType').value;
            const reportPeriod = document.getElementById('reportPeriod').value;
            let startDate, endDate;
            
            if (reportPeriod === 'custom') {
                startDate = document.getElementById('startDate').value;
                endDate = document.getElementById('endDate').value;
                
                if (!startDate || !endDate) {
                    showNotification("Veuillez spécifier une plage de dates", "error");
                    return;
                }
            } else {
                const today = new Date();
                
                switch(reportPeriod) {
                    case 'today':
                        startDate = endDate = today.toISOString().split('T')[0];
                        break;
                    case 'week':
                        startDate = new Date(today.setDate(today.getDate() - today.getDay()));
                        endDate = new Date(today.setDate(today.getDate() + 6));
                        break;
                    case 'month':
                        startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                        endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                        break;
                    case 'quarter':
                        const quarter = Math.floor(today.getMonth() / 3);
                        startDate = new Date(today.getFullYear(), quarter * 3, 1);
                        endDate = new Date(today.getFullYear(), quarter * 3 + 3, 0);
                        break;
                    case 'year':
                        startDate = new Date(today.getFullYear(), 0, 1);
                        endDate = new Date(today.getFullYear(), 11, 31);
                        break;
                    default: // 'all'
                        startDate = null;
                        endDate = null;
                }
                
                if (startDate && endDate) {
                    startDate = startDate.toISOString().split('T')[0];
                    endDate = endDate.toISOString().split('T')[0];
                }
            }
            
            const reportOutput = document.getElementById('reportOutput');
            reportOutput.innerHTML = '<p>Génération du rapport en cours...</p>';
            
            // Générer le rapport en fonction du type
            if (reportType === 'equipment_list') {
                generateEquipmentReport(reportOutput);
            } else if (reportType === 'maintenance_tasks') {
                generateTasksReport(reportOutput, startDate, endDate);
            } else if (reportType === 'incident_report') {
                generateIncidentsReport(reportOutput, startDate, endDate);
            } else if (reportType === 'preventive_maintenance') {
                generatePreventiveMaintenanceReport(reportOutput);
            }
        }
        
        function generateEquipmentReport(outputElement) {
            const transaction = db.transaction(["equipments"], "readonly");
            const store = transaction.objectStore("equipments");
            const request = store.getAll();
            
            request.onsuccess = function(event) {
                const equipments = event.target.result;
                
                let html = '<h3>Liste des équipements</h3>';
                html += '<table><thead><tr><th>Nom</th><th>Type</th><th>Localisation</th><th>N° série</th><th>Date installation</th></tr></thead><tbody>';
                
                equipments.forEach(equipment => {
                    html += `
                        <tr>
                            <td>${equipment.name}</td>
                            <td>${equipment.type}</td>
                            <td>${equipment.location}</td>
                            <td>${equipment.serial}</td>
                            <td>${equipment.installDate}</td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                outputElement.innerHTML = html;
            };
        }
        
        function generateTasksReport(outputElement, startDate, endDate) {
            const transaction = db.transaction(["tasks", "equipments"], "readonly");
            const taskStore = transaction.objectStore("tasks");
            const equipmentStore = transaction.objectStore("equipments");
            const request = taskStore.getAll();
            
            request.onsuccess = function(event) {
                let tasks = event.target.result;
                
                // Filtrer par date si nécessaire
                if (startDate && endDate) {
                    tasks = tasks.filter(task => task.dueDate >= startDate && task.dueDate <= endDate);
                }
                
                let html = '<h3>Rapport des tâches de maintenance</h3>';
                
                if (startDate && endDate) {
                    html += `<p>Période : du ${startDate} au ${endDate}</p>`;
                }
                
                html += '<table><thead><tr><th>Équipement</th><th>Type</th><th>Description</th><th>Date prévue</th><th>Statut</th><th>Remarques</th></tr></thead><tbody>';
                
                tasks.forEach(task => {
                    html += `
                        <tr>
                            <td>${task.equipmentName} (${task.equipmentLocation})</td>
                            <td>${getTaskTypeLabel(task.type)}</td>
                            <td>${task.description}</td>
                            <td>${task.dueDate}</td>
                            <td>${task.status === 'pending' ? 'En attente' : 'Réalisée'}</td>
                            <td>${task.remarks || '-'}</td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                outputElement.innerHTML = html;
            };
        }
        
        function generateIncidentsReport(outputElement, startDate, endDate) {
            const transaction = db.transaction(["incidents", "equipments"], "readonly");
            const incidentStore = transaction.objectStore("incidents");
            const equipmentStore = transaction.objectStore("equipments");
            const request = incidentStore.getAll();
            
            request.onsuccess = function(event) {
                let incidents = event.target.result;
                
                // Filtrer par date si nécessaire
                if (startDate && endDate) {
                    incidents = incidents.filter(incident => incident.date >= startDate && incident.date <= endDate);
                }
                
                let html = '<h3>Rapport des incidents</h3>';
                
                if (startDate && endDate) {
                    html += `<p>Période : du ${startDate} au ${endDate}</p>`;
                }
                
                html += '<table><thead><tr><th>ID</th><th>Titre</th><th>Équipement</th><th>Priorité</th><th>Statut</th><th>Date</th></tr></thead><tbody>';
                
                incidents.forEach(incident => {
                    let priorityLabel;
                    switch(incident.priority) {
                        case 'low': priorityLabel = 'Basse'; break;
                        case 'medium': priorityLabel = 'Moyenne'; break;
                        case 'high': priorityLabel = 'Haute'; break;
                        case 'critical': priorityLabel = 'Critique'; break;
                        default: priorityLabel = incident.priority;
                    }
                    
                    let statusLabel;
                    switch(incident.status) {
                        case 'open': statusLabel = 'Ouvert'; break;
                        case 'in_progress': statusLabel = 'En cours'; break;
                        case 'resolved': statusLabel = 'Résolu'; break;
                        case 'closed': statusLabel = 'Clôturé'; break;
                        default: statusLabel = incident.status;
                    }
                    
                    html += `
                        <tr>
                            <td>${incident.id}</td>
                            <td>${incident.title}</td>
                            <td>${incident.equipmentName} (${incident.equipmentLocation})</td>
                            <td>${priorityLabel}</td>
                            <td>${statusLabel}</td>
                            <td>${incident.date}</td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                outputElement.innerHTML = html;
            };
        }
        
        function generatePreventiveMaintenanceReport(outputElement) {
            const transaction = db.transaction(["tasks", "equipments"], "readonly");
            const taskStore = transaction.objectStore("tasks");
            const equipmentStore = transaction.objectStore("equipments");
            const request = taskStore.getAll();
            
            request.onsuccess = function(event) {
                const tasks = event.target.result.filter(task => task.type === 'preventive');
                
                let html = '<h3>Rapport de maintenance préventive</h3>';
                html += '<table><thead><tr><th>Équipement</th><th>Description</th><th>Fréquence</th><th>Prochaine date</th><th>Statut</th></tr></thead><tbody>';
                
                tasks.forEach(task => {
                    let frequencyLabel;
                    switch(task.frequency) {
                        case 'daily': frequencyLabel = 'Quotidienne'; break;
                        case 'weekly': frequencyLabel = 'Hebdomadaire'; break;
                        case 'monthly': frequencyLabel = 'Mensuelle'; break;
                        case 'quarterly': frequencyLabel = 'Trimestrielle'; break;
                        case 'yearly': frequencyLabel = 'Annuelle'; break;
                        default: frequencyLabel = task.frequency;
                    }
                    
                    html += `
                        <tr>
                            <td>${task.equipmentName} (${task.equipmentLocation})</td>
                            <td>${task.description}</td>
                            <td>${frequencyLabel}</td>
                            <td>${task.dueDate}</td>
                            <td>${task.status === 'pending' ? 'En attente' : 'Réalisée'}</td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                outputElement.innerHTML = html;
            };
        }
        
        // Initialisation
        document.getElementById('reportPeriod').addEventListener('change', function() {
            document.getElementById('customDateRange').style.display = 
                this.value === 'custom' ? 'block' : 'none';
        });
    </script>
</body>
</html>